import pytest
from webdriver_manager.chrome import ChromeDriverManager
from selenium.webdriver.chrome.service import Service as ChromeService
from selenium.webdriver.chrome.options import Options as ChromeOptions
from selenium import webdriver


@pytest.fixture(params=['chrome', 'firefox'], scope='class')
def init_driver(request):
    if request.param == "chrome":
        ChromeOptions().add_argument("--headless") # turn on headless mode
        web_driver = webdriver.Chrome(service=ChromeService(ChromeDriverManager().install()))
    if request.param == "firefox":
        webdriver.FirefoxOptions().headless = True  # turn on headless mode
        web_driver = webdriver.Firefox()
    request.cls.driver = web_driver
    # web_driver.implicitly_wait(10)
    yield
    web_driver.close()


@pytest.hookimpl(tryfirst=True)
def pytest_runtest_makereport(item, call):
    if "init_driver" in item.fixturenames:
        try:
            web_driver = item.cls.driver
        except AttributeError:
            # Handle the case where the driver is not available
            return

        if call.excinfo is not None:
            # Test failed, take a screenshot
            screenshot_path = f"Reports/screenshots/{item.name}_failure_hook.png"
            try:
                web_driver.save_screenshot(screenshot_path)
            except Exception as e:
                # Handle errors while saving the screenshot
                print(f"Error saving screenshot: {e}")
                return

            # Use result log path if available, otherwise use a default path
            result_log_path = getattr(item.config.option, 'resultlog', 'default_log.txt')
            with open(result_log_path, "a") as log:
                log.write(f"\nScreenshot (from hook): {screenshot_path}")
